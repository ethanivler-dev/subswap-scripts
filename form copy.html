<!DOCTYPE html>
<html lang="en">
<head>
  <link href="https://cdn.prod.website-files.com/6947597ed86d42b608e31b5c/css/subswap.webflow.shared.cd2bf0a8c.css" rel="stylesheet" type="text/css" crossorigin="anonymous"/>
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;600&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet" />

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY&libraries=places" async defer></script>

<style>
  :root {
    --gold:        #B8922A;
    --gold-light:  #D4AC52;
    --gold-pale:   #F5EDD6;
    --gold-btn:    #C9A84C;
    --cream:       #FAF7F2;
    --ink:         #1C1810;
    --ink-soft:    #4A4035;
    --ink-muted:   #8A7D6B;
    --border:      #E0D5C0;
    --white:       #FFFFFF;
    --red:         #C0392B;
    --green:       #3D8A58;
    --radius-sm:   6px;
    --radius-md:   10px;
    --radius-lg:   16px;
    --shadow-card: 0 2px 12px rgba(28,24,16,0.07);
    --shadow-btn:  0 4px 20px rgba(184,146,42,0.35);
    --transition:  0.18s ease;
  }

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  html { font-size: 16px; scroll-behavior: smooth; }
  body { font-family: 'DM Sans', sans-serif; background: var(--cream); color: var(--ink); min-height: 100vh; }

  /* hide webflow nav */
  .w-nav, .navbar, [class*="navbar"], .w-nav-brand, .w-nav-menu, .w-nav-button { display: none !important; }

  /* ‚îÄ‚îÄ NAV ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  nav.ss-nav {
    background: var(--white);
    border-bottom: 1px solid var(--border);
    position: sticky; top: 0; z-index: 9999;
    padding: 0 48px; height: 60px;
    display: flex !important; flex-direction: row !important; align-items: center !important; justify-content: space-between !important;
    width: 100%;
  }
  nav.ss-nav .nav-logo { display: flex; align-items: center; gap: 9px; text-decoration: none; white-space: nowrap; flex-shrink: 0; margin-right: 40px; }
  nav.ss-nav .nav-links { display: flex !important; flex-direction: row !important; align-items: center !important; flex: 1; justify-content: space-around; gap: 20px; flex-wrap: nowrap; }
  nav.ss-nav .nav-links a { font-size: .875rem; font-weight: 400; color: var(--ink-soft); text-decoration: none; transition: color var(--transition); white-space: nowrap; }
  nav.ss-nav .nav-links a:hover { color: var(--gold); }
  nav.ss-nav .nav-links a.active { color: var(--ink); font-weight: 600; border-bottom: 2px solid var(--gold); padding-bottom: 2px; }

  .nav-hamburger { display: none; background: none; border: none; cursor: pointer; padding: 6px; color: var(--ink-soft); flex-shrink: 0; align-items: center; justify-content: center; }
  .nav-hamburger:hover { color: var(--gold); }
  .nav-mobile-menu { display: none; position: absolute; top: 60px; left: 0; right: 0; background: var(--white); border-bottom: 1px solid var(--border); box-shadow: 0 4px 16px rgba(28,24,16,0.08); padding: 8px 0; z-index: 9998; }
  .nav-mobile-menu.open { display: block; }
  .nav-mobile-menu a { display: block; padding: 12px 24px; font-size: .9rem; font-weight: 400; color: var(--ink-soft); text-decoration: none; transition: background var(--transition), color var(--transition); border-left: 3px solid transparent; }
  .nav-mobile-menu a:hover { background: var(--gold-pale); color: var(--gold); border-left-color: var(--gold-light); }
  .nav-mobile-menu a.active { color: var(--ink); font-weight: 600; background: var(--gold-pale); border-left-color: var(--gold); }

  /* ‚îÄ‚îÄ PAGE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  .page { max-width: 1200px; margin: 0 auto; padding: 48px 40px 80px; }
  .page-title { font-family: 'Playfair Display', serif; font-size: 2.25rem; font-weight: 600; color: var(--ink); margin-bottom: 8px; }
  .email-notice { font-size: 0.875rem; color: var(--ink-muted); margin-bottom: 28px; }
  .name-row { display: grid; grid-template-columns: 1.6fr 1fr 1fr; gap: 12px; margin-bottom: 28px; }
  .name-row input { background: var(--white) !important; }
  .form-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }
  .card { background: var(--white); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 24px; box-shadow: var(--shadow-card); animation: fadeUp .4s ease both; }
  .card:nth-child(1){animation-delay:.05s} .card:nth-child(2){animation-delay:.10s} .card:nth-child(3){animation-delay:.15s}
  .card:nth-child(4){animation-delay:.20s} .card:nth-child(5){animation-delay:.25s} .card:nth-child(6){animation-delay:.30s}
  .card:nth-child(7){animation-delay:.35s} .card:nth-child(8){animation-delay:.40s}
  .card-title { font-family: 'Playfair Display', serif; font-size: 1.0625rem; font-weight: 600; color: var(--ink); margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
  .tag-required { font-family: 'DM Sans', sans-serif; font-size: .7rem; font-weight: 500; color: var(--gold); letter-spacing: .04em; text-transform: uppercase; }
  .half-width { grid-column: span 2; }
  label { display: block; font-size: .8125rem; font-weight: 500; color: var(--ink-soft); margin-bottom: 5px; }
  input[type="text"], input[type="email"], input[type="tel"], input[type="number"], input[type="date"], select, textarea {
    width: 100%; background: var(--white); border: 1.5px solid var(--border); border-radius: var(--radius-sm);
    padding: 9px 12px; font-family: 'DM Sans', sans-serif; font-size: .875rem; color: var(--ink); outline: none; transition: border-color var(--transition), box-shadow var(--transition); appearance: none; -webkit-appearance: none;
  }
  input:focus, select:focus, textarea:focus { border-color: var(--gold-light); box-shadow: 0 0 0 3px rgba(184,146,42,0.12); }
  input::placeholder, textarea::placeholder { color: var(--ink-muted); }
  select { cursor: pointer; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%238A7D6B' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 12px center; padding-right: 32px; }
  textarea { resize: vertical; min-height: 110px; line-height: 1.5; }
  .field { margin-bottom: 14px; }
  .field:last-child { margin-bottom: 0; }
  .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
  input[readonly] { background: var(--gold-pale) !important; color: var(--ink-soft); cursor: default; border-color: var(--border); }
  .input-prefix { display: flex; align-items: center; border: 1.5px solid var(--border); border-radius: var(--radius-sm); background: var(--white); overflow: hidden; transition: border-color var(--transition), box-shadow var(--transition); }
  .input-prefix:focus-within { border-color: var(--gold-light); box-shadow: 0 0 0 3px rgba(184,146,42,0.12); }
  .input-prefix span { padding: 9px 10px 9px 12px; font-size: .875rem; color: var(--ink-muted); background: transparent; white-space: nowrap; }
  .input-prefix input { border: none !important; background: transparent !important; box-shadow: none !important; padding-left: 0; flex: 1; }
  .toggle-group { display: flex; gap: 8px; flex-wrap: wrap; }
  .toggle-btn { padding: 7px 14px; border-radius: var(--radius-sm); border: 1.5px solid var(--border); background: var(--white); font-family: 'DM Sans', sans-serif; font-size: .8125rem; font-weight: 500; color: var(--ink-soft); cursor: pointer; transition: all var(--transition); }
  .toggle-btn:hover { border-color: var(--gold-light); color: var(--gold); }
  .toggle-btn.active { background: var(--gold-pale); border-color: var(--gold); color: var(--gold); }
  .radio-group { display: flex; gap: 16px; align-items: center; flex-wrap: wrap; }
  .radio-label { display: flex; align-items: center; gap: 7px; font-size: .875rem; color: var(--ink-soft); cursor: pointer; font-weight: 400; }
  .radio-label input[type="radio"] { width: 17px; height: 17px; accent-color: var(--gold); cursor: pointer; }
  .contact-toggle { display: flex; gap: 8px; }
  .contact-btn { display: flex; align-items: center; gap: 6px; padding: 8px 14px; border-radius: var(--radius-sm); border: 1.5px solid var(--border); background: var(--white); font-family: 'DM Sans', sans-serif; font-size: .8125rem; color: var(--ink-soft); cursor: pointer; transition: all var(--transition); }
  .contact-btn.active { background: var(--gold-pale); border-color: var(--gold); color: var(--gold); }
  .address-wrap { position: relative; width: 100%; }
  #address-suggestions { position: absolute; top: calc(100% + 4px); left: 0; right: 0; background: var(--white); border: 1.5px solid var(--gold-light); border-radius: var(--radius-md); box-shadow: 0 8px 24px rgba(28,24,16,0.12); z-index: 999; overflow: hidden; display: none; }
  #address-suggestions.open { display: block; }
  .addr-suggestion { padding: 10px 14px; font-size: .875rem; color: var(--ink-soft); cursor: pointer; border-bottom: 1px solid var(--border); transition: background var(--transition); display: flex; align-items: flex-start; gap: 8px; }
  .addr-suggestion:last-child { border-bottom: none; }
  .addr-suggestion:hover { background: var(--gold-pale); color: var(--ink); }
  .addr-suggestion svg { flex-shrink: 0; color: var(--gold); margin-top: 2px; }
  .addr-suggestion .addr-main { font-weight: 500; color: var(--ink); font-size: .875rem; display: block; }
  .addr-suggestion .addr-secondary { font-size: .78rem; color: var(--ink-muted); display: block; margin-top: 1px; }
  .google-attribution { padding: 6px 12px; display: flex; align-items: center; justify-content: flex-end; gap: 4px; font-size: .7rem; color: var(--ink-muted); border-top: 1px solid var(--border); background: var(--cream); }
  #neighborhood-badge { font-size: .8rem; color: var(--ink-soft); background: var(--gold-pale); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 5px 10px; display: none; align-items: center; gap: 6px; margin-top: 6px; }
  #neighborhood-badge.visible { display: flex; }
  #neighborhood-badge svg { color: var(--gold); flex-shrink: 0; }
  .date-info-row { display: flex; align-items: center; gap: 6px; margin-bottom: 8px; }
  .date-info-row label { margin-bottom: 0; }
  .info-btn { background: none; border: 1.5px solid var(--border); border-radius: 50%; width: 18px; height: 18px; font-size: .65rem; font-weight: 700; color: var(--ink-muted); cursor: pointer; display: inline-flex; align-items: center; justify-content: center; transition: all var(--transition); flex-shrink: 0; font-family: serif; font-style: italic; }
  .info-btn:hover { border-color: var(--gold); color: var(--gold); }
  .info-popup { display: none; background: var(--white); border: 1px solid var(--border); border-radius: var(--radius-md); padding: 12px 14px; font-size: .8rem; color: var(--ink-soft); line-height: 1.6; box-shadow: var(--shadow-card); margin-top: 6px; }
  .info-popup.visible { display: block; }
  .info-popup strong { color: var(--ink); display: block; margin-bottom: 2px; }
  .date-error { font-size: .75rem; color: var(--red); margin-top: 4px; display: none; }
  .date-error.visible { display: block; }
  .upload-zone { border: 2px dashed var(--border); border-radius: var(--radius-md); padding: 24px 16px; text-align: center; cursor: pointer; transition: all var(--transition); background: var(--white); position: relative; }
  .upload-zone:hover { border-color: var(--gold); background: var(--gold-pale); }
  .upload-zone input[type="file"] { position: absolute; inset: 0; opacity: 0; cursor: pointer; width: 100%; }
  .upload-icon { width: 40px; height: 40px; margin: 0 auto 10px; background: var(--gold-pale); border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 1.5px solid var(--border); }
  .upload-icon svg { color: var(--gold); }
  .upload-hint { font-size: .8rem; color: var(--ink-muted); margin-top: 4px; }
  .upload-min { font-size: .78rem; color: var(--gold); font-weight: 500; margin-top: 6px; }

  /* ‚îÄ‚îÄ PHOTO STRIP & REORDERING ‚îÄ‚îÄ */
  #photo-strip { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 12px; }
  .photo-thumb-wrap { position: relative; width: 64px; height: 64px; cursor: grab; }
  .photo-thumb-wrap img { width: 100%; height: 100%; object-fit: cover; border-radius: var(--radius-sm); border: 1.5px solid var(--border); display: block; }
  .photo-thumb-wrap:first-child img { border-color: var(--gold); border-width: 2px; }
  .photo-thumb-wrap:first-child::after { content: 'COVER'; position: absolute; bottom: -8px; left: 50%; transform: translateX(-50%); background: var(--gold); color: white; font-size: 8px; font-weight: 800; padding: 2px 4px; border-radius: 3px; }
  .photo-delete { position: absolute; top: -6px; right: -6px; width: 18px; height: 18px; border-radius: 50%; background: var(--red); color: white; border: 2px solid white; font-size: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: 900; box-shadow: 0 1px 4px rgba(0,0,0,0.25); z-index: 2; }
  .photo-count { font-size: .78rem; color: var(--ink-muted); margin-top: 6px; }

  .pets-expand, .furnished-expand { overflow: hidden; max-height: 0; transition: max-height .35s ease, opacity .3s ease; opacity: 0; }
  .pets-expand.open, .furnished-expand.open { max-height: 300px; opacity: 1; margin-top: 12px; overflow: visible; }
  .pet-options { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 10px; }
  .pet-tag { padding: 6px 14px; border-radius: 20px; border: 1.5px solid var(--border); background: var(--white); font-size: .8rem; font-weight: 500; color: var(--ink-soft); cursor: pointer; transition: all var(--transition); }
  .pet-tag.active { background: var(--gold-pale); border-color: var(--gold); color: var(--gold); }
  .date-wrap { position: relative; display: block; }
  .date-wrap input[type="date"] { width: 100%; padding-right: 38px; }
  .date-wrap::after { content: ''; position: absolute; right: 11px; top: 50%; transform: translateY(-50%); width: 18px; height: 18px; pointer-events: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='18' height='18' viewBox='0 0 18 18' fill='none'%3E%3Crect x='1' y='3' width='16' height='14' rx='2' stroke='%238A7D6B' stroke-width='1.4'/%3E%3Cpath d='M1 7h16' stroke='%238A7D6B' stroke-width='1.4'/%3E%3Cpath d='M5 1v4M13 1v4' stroke='%238A7D6B' stroke-width='1.4' stroke-linecap='round'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-size: 18px 18px; opacity: 0.55; }
  input[type="date"]::-webkit-calendar-picker-indicator { position: absolute; right: 0; top: 0; width: 38px; height: 100%; opacity: 0; cursor: pointer; }
  input[type="date"]::-webkit-inner-spin-button { display: none; }
  .lease-check { display: flex; align-items: center; gap: 10px; padding: 10px 12px; border: 1.5px solid var(--border); border-radius: var(--radius-sm); margin-bottom: 10px; background: var(--white); cursor: pointer; transition: all var(--transition); font-size: .875rem; color: var(--ink-soft); }
  .lease-check:hover { border-color: var(--gold-light); }
  .lease-check input { accent-color: var(--gold); width: 16px; height: 16px; }
  .lease-check.error { border-color: var(--red); background: #fdf2f2; }
  .confirm-item { display: flex; align-items: flex-start; gap: 10px; font-size: .875rem; color: var(--ink-soft); margin-bottom: 12px; line-height: 1.5; transition: all var(--transition); border-radius: var(--radius-sm); padding: 6px 8px; margin-left: -8px; margin-right: -8px; }
  .confirm-item:last-child { margin-bottom: 0; }
  .confirm-item input[type="checkbox"] { width: 17px; height: 17px; flex-shrink: 0; margin-top: 2px; accent-color: var(--gold); cursor: pointer; }
  .confirm-item a { color: var(--gold); text-decoration: underline; }
  .confirm-item strong { color: var(--ink); font-weight: 600; }
  .confirm-item.error { background: #fdf2f2; color: var(--red) !important; border: 1px solid rgba(192,57,43,0.3); }
  .confirm-item.error a { color: #a93226; }
  .confirm-item.error strong { color: var(--red); }
  #ci-tos.error { background: #fdf2f2; border: 1.5px solid var(--red); }
  .confirm-error-banner { display: none; margin-top: 14px; padding: 10px 14px; background: #fdf2f2; border: 1.5px solid var(--red); border-radius: var(--radius-sm); font-size: .8125rem; color: var(--red); font-weight: 500; display: flex; align-items: center; gap: 8px; }
  .confirm-error-banner.hidden { display: none !important; }
  .confirm-error-banner svg { flex-shrink: 0; }
  .submit-row { display: flex; justify-content: center; margin-top: 32px; }
  .btn-submit { background: linear-gradient(135deg, var(--gold-btn), var(--gold)); color: var(--white); font-family: 'DM Sans', sans-serif; font-size: 1rem; font-weight: 600; letter-spacing: .03em; padding: 15px 64px; border: none; border-radius: var(--radius-md); cursor: pointer; box-shadow: var(--shadow-btn); transition: all var(--transition); }
  .btn-submit:hover { transform: translateY(-2px); box-shadow: 0 8px 28px rgba(184,146,42,0.45); }
  .btn-submit:active { transform: translateY(0); }
  #success-screen { display: none; max-width: 560px; margin: 30px auto; text-align: center; animation: fadeUp .5s ease both; }
  #success-screen.visible { display: block; }
  .success-icon { width: 60px; height: 60px; margin: 0 auto 16px; background: #EAF7EF; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid #A8D5B5; }
  .success-icon svg { color: var(--green); }
  .success-title { font-family: 'Playfair Display', serif; font-size: 1.8rem; font-weight: 600; color: var(--ink); margin-bottom: 8px; }
  .success-sub { font-size: .9375rem; color: var(--ink-soft); line-height: 1.6; margin-bottom: 24px; }
  .verify-box { background: var(--white); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 24px; box-shadow: var(--shadow-card); margin-bottom: 20px; }
  .verify-box h3 { font-family: 'Playfair Display', serif; font-size: 1.125rem; font-weight: 600; color: var(--ink); margin-bottom: 8px; }
  .verify-box p { font-size: .8125rem; color: var(--ink-soft); margin-bottom: 16px; line-height: 1.6; }
  .verify-input-row { display: flex; gap: 10px; }
  .verify-input-row input { flex: 1; text-align: center; letter-spacing: .2em; font-size: 1.25rem; font-weight: 600; }
  .btn-verify { background: linear-gradient(135deg, var(--gold-btn), var(--gold)); color: var(--white); font-family: 'DM Sans', sans-serif; font-size: .875rem; font-weight: 600; padding: 10px 22px; border: none; border-radius: var(--radius-sm); cursor: pointer; white-space: nowrap; transition: all var(--transition); }
  .btn-verify:hover { opacity: .9; }
  .success-next { background: var(--gold-pale); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 16px 20px; text-align: left; margin-bottom: 20px; }
  .success-next h4 { font-size: .8rem; font-weight: 600; color: var(--gold); text-transform: uppercase; letter-spacing: .06em; margin-bottom: 10px; }
  .success-next ul { list-style: none; padding: 0; }
  .success-next ul li { font-size: .875rem; color: var(--ink-soft); padding: 4px 0; display: flex; gap: 10px; line-height: 1.5; }
  .success-next ul li::before { content: '‚Üí'; color: var(--gold); flex-shrink: 0; }
  .btn-edit { background: transparent; border: 1.5px solid var(--border); color: var(--ink-soft); font-family: 'DM Sans', sans-serif; font-size: .875rem; font-weight: 500; padding: 10px 28px; border-radius: var(--radius-sm); cursor: pointer; transition: all var(--transition); margin-bottom: 20px; width: 100%;}
  .btn-edit:hover { border-color: var(--gold); background: var(--white); color: var(--gold); }
  .autosave-badge { position: fixed; bottom: 24px; left: 24px; z-index: 1000; background: var(--white); border: 1px solid var(--border); border-radius: 30px; padding: 8px 16px; font-size: .75rem; color: var(--gold); font-weight: 600; box-shadow: 0 4px 12px rgba(0,0,0,0.08); opacity: 0; transition: opacity .35s ease; pointer-events: none; display: flex; align-items: center; gap: 6px; }
  .autosave-badge.visible { opacity: 1; }
  .footer-note { text-align: center; font-size: .78rem; color: var(--ink-muted); margin-top: 28px; line-height: 1.6; }
  .error-msg { font-size: .75rem; color: var(--red); margin-top: 4px; display: block; }
  @keyframes fadeUp { from { opacity: 0; transform: translateY(14px); } to { opacity: 1; transform: translateY(0); } }
  .card.listing-content-card { display: flex; flex-direction: column; }
  .card.listing-content-card .field { flex: 1; display: flex; flex-direction: column; margin-bottom: 0; }
  .card.listing-content-card textarea { flex: 1; min-height: 160px; }
  @media (max-width: 960px) { .form-grid { grid-template-columns: 1fr 1fr; } .half-width { grid-column: span 2; } }
  @media (max-width: 720px) { nav.ss-nav { padding: 0 20px; } nav.ss-nav .nav-links { display: none !important; } .nav-hamburger { display: flex !important; } .autosave-badge { bottom: 12px; left: 12px; } }
  @media (max-width: 640px) { .form-grid { grid-template-columns: 1fr; } .half-width { grid-column: span 1; } .name-row { grid-template-columns: 1fr 1fr; } .name-row .field:first-child { grid-column: 1 / -1; } .page { padding: 28px 16px 60px; } .page-title { font-size: 1.75rem; } }
</style>
</head>

<body>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<div id="autosave-badge" class="autosave-badge">
  <svg width="12" height="12" viewBox="0 0 12 12" fill="none"><path d="M10 3L4.5 8.5L2 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
  Draft Saved
</div>

<nav class="ss-nav" style="position:relative;">
  <a href="/" class="nav-logo">
    <img src="https://cdn.prod.website-files.com/6947597ed86d42b608e31b5c/699906188f0daf6fc970f08e_Image%202-20-26%20at%206.09%E2%80%AFPM.jpeg" alt="SubletBuff" style="height:40px;width:auto;" />
  </a>
  <div class="nav-links" id="nav-links-desktop">
    <a href="/">Home</a>
    <a href="#">How It Works</a>
    <a href="#">Listings</a>
    <a href="/form-submission" class="active" id="nav-post-link">Post a Listing</a>
  </div>
  <button class="nav-hamburger" id="nav-hamburger" aria-label="Open menu">
    <svg width="22" height="22" viewBox="0 0 22 22" fill="none">
      <path d="M3 6h16M3 11h16M3 16h16" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
    </svg>
  </button>
  <div class="nav-mobile-menu" id="nav-mobile-menu">
    <a href="/">Home</a>
    <a href="#">How It Works</a>
    <a href="#">Listings</a>
    <a href="/form-submission" class="active" id="nav-post-link-mobile">Post a Listing</a>
  </div>
</nav>

<main class="page">
  <h1 class="page-title">Post a Listing</h1>
  <p class="email-notice">A verification email will be sent to your CU email when this form is submitted</p>

  <form id="listing-form" novalidate>

    <div class="name-row">
      <div class="field">
        <input type="email" id="email" placeholder="CU Boulder Email (@colorado.edu)" autocomplete="off" />
        <span class="error-msg" id="email-error" style="display:none"></span>
      </div>
      <div class="field"><input type="text" id="first-name" placeholder="First Name" /></div>
      <div class="field"><input type="text" id="last-name" placeholder="Last Name" /></div>
    </div>

    <div class="form-grid">

      <div class="card">
        <div class="card-title">Property Basics <span class="tag-required">Required</span></div>

        <div class="field">
          <label>Monthly Rent</label>
          <div class="input-prefix">
            <span>$</span>
            <input type="number" id="rent" placeholder="0" min="0" />
            <span>/ mo</span>
          </div>
        </div>

        <div class="field">
          <label>Street Address</label>
          <div class="address-wrap">
            <input type="text" id="address" placeholder="123 College Ave" autocomplete="off" style="width:100%;margin-bottom:0" />
            <div id="address-suggestions"></div>
          </div>
        </div>

        <div class="field">
          <label>Unit / Apt # <span style="color:var(--ink-muted);font-weight:400">(Optional)</span></label>
          <input type="text" id="unit-number" placeholder="e.g. Apt 3B" />
        </div>

        <div id="neighborhood-badge">
          <svg width="12" height="12" viewBox="0 0 12 12" fill="none"><circle cx="6" cy="6" r="5" stroke="currentColor" stroke-width="1.3"/><path d="M6 4v2.5M6 8h.01" stroke="currentColor" stroke-width="1.3" stroke-linecap="round"/></svg>
          <span id="neighborhood-text"></span>
        </div>
        <input type="hidden" id="neighborhood" />

        <div class="two-col field" style="margin-top:14px">
          <div>
            <label>Beds</label>
            <select id="beds">
              <option value="">Beds</option>
              <option>Studio</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5+</option>
            </select>
          </div>
          <div>
            <label>Baths</label>
            <select id="baths">
              <option value="">Baths</option>
              <option>1</option><option>1.5</option><option>2</option><option>2.5</option><option>3+</option>
            </select>
          </div>
        </div>

        <div class="field">
          <label>Furnished</label>
          <div class="radio-group">
            <label class="radio-label"><input type="radio" name="furnished" value="yes" id="furn-yes" /> Yes</label>
            <label class="radio-label"><input type="radio" name="furnished" value="no" id="furn-no" /> No</label>
          </div>
          <div class="furnished-expand" id="furnished-expand">
            <textarea id="furnished-notes" placeholder="Describe furnishings (e.g. Bed frame, desk, dresser included...)" style="margin-top:10px; min-height:60px; resize:vertical;"></textarea>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-title">Lease Timing <span class="tag-required">Required</span></div>
        <div class="field">
          <div class="date-info-row">
            <label>Start Date</label>
            <button type="button" class="info-btn" id="sem-info-btn" title="View semester dates">i</button>
          </div>
          <div class="info-popup" id="sem-info-popup">
            <strong>CU Boulder Semester Dates</strong>
            Summer 2025: May 10 ‚Äì Aug 10<br/>Fall 2025: Aug 25 ‚Äì Dec 20<br/>Spring 2026: Jan 12 ‚Äì May 8
          </div>
          <div class="date-wrap">
            <input type="date" id="start-date" />
          </div>
          <span class="date-error" id="start-error"></span>
        </div>
        <div class="field">
          <label>End Date</label>
          <div class="date-wrap">
            <input type="date" id="end-date" />
          </div>
          <span class="date-error" id="end-error"></span>
        </div>
        <div class="field">
          <label>Flexible Move-In?</label>
          <div class="radio-group">
            <label class="radio-label"><input type="radio" name="flexible" value="yes" /> Yes</label>
            <label class="radio-label"><input type="radio" name="flexible" value="no" /> No</label>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-title">Contact Information</div>
        <div class="field">
          <label>Phone Number <span style="color:var(--ink-muted);font-weight:400">(Optional)</span></label>
          <input type="tel" id="phone" placeholder="(303) 555-0000" />
        </div>
        <div class="field">
          <label>Preferred Contact</label>
          <div class="contact-toggle">
            <button type="button" class="contact-btn" id="pref-email">
              <svg width="14" height="14" viewBox="0 0 14 14" fill="none"><rect x="1" y="2.5" width="12" height="9" rx="1.5" stroke="currentColor" stroke-width="1.4"/><path d="M1 4l6 4 6-4" stroke="currentColor" stroke-width="1.4"/></svg>
              Email
            </button>
            <button type="button" class="contact-btn" id="pref-text">
              <svg width="14" height="14" viewBox="0 0 14 14" fill="none"><rect x="1" y="1" width="12" height="10" rx="1.5" stroke="currentColor" stroke-width="1.4"/><path d="M4 13l3-2 3 2" stroke="currentColor" stroke-width="1.3"/></svg>
              Text
            </button>
          </div>
        </div>
        <div class="field">
          <label>Best Time to Reach <span style="color:var(--ink-muted);font-weight:400">(Optional)</span></label>
          <select id="best-time">
            <option value="">Anytime</option>
            <option>Morning (8am‚Äì12pm)</option>
            <option>Afternoon (12pm‚Äì5pm)</option>
            <option>Evening (5pm‚Äì9pm)</option>
          </select>
        </div>
      </div>

      <div class="card">
        <div class="card-title">Housing Details <span class="tag-required">Required</span></div>
        <div class="field">
          <label>Housing Type</label>
          <div class="toggle-group" id="housing-type">
            <button type="button" class="toggle-btn" data-val="apartment">Apartment</button>
            <button type="button" class="toggle-btn" data-val="house">House</button>
            <button type="button" class="toggle-btn" data-val="condo">Condo</button>
          </div>
        </div>
        <div class="field">
          <label>Unit Type</label>
          <div class="toggle-group" id="unit-type">
            <button type="button" class="toggle-btn" data-val="entire">Entire Unit</button>
            <button type="button" class="toggle-btn" data-val="room-shared">Room in Shared Unit</button>
            <button type="button" class="toggle-btn" data-val="shared-room">Shared Room</button>
          </div>
        </div>
        <div class="field" id="room-until-field" style="display:none">
          <label>Room Available Until</label>
          <select id="room-until">
            <option value="">Select‚Ä¶</option>
            <option>Summer 2025</option><option>Fall 2025</option>
            <option>Spring 2026</option><option>Summer 2026</option>
          </select>
        </div>
        <div class="field">
          <label>Gender Preference for Roommates</label>
          <select id="gender-pref">
            <option value="">No preference</option>
            <option value="Male only">Male only</option>
            <option value="Female only">Female only</option>
            <option value="Non-binary friendly">Non-binary friendly</option>
            <option value="Any / all welcome">Any / all welcome</option>
          </select>
        </div>
        <div class="field">
          <label>Pets Allowed?</label>
          <div class="radio-group">
            <label class="radio-label"><input type="radio" name="pets-prop" value="yes" id="pets-yes" /> Yes</label>
            <label class="radio-label"><input type="radio" name="pets-prop" value="no" id="pets-no" /> No</label>
          </div>
          <div class="pets-expand" id="pets-expand">
            <label style="margin-bottom:6px">Which pets?</label>
            <div class="pet-options">
              <button type="button" class="pet-tag" data-pet="Dogs">üê∂ Dogs</button>
              <button type="button" class="pet-tag" data-pet="Cats">üê± Cats</button>
              <button type="button" class="pet-tag" data-pet="Birds">üê¶ Birds</button>
              <button type="button" class="pet-tag" data-pet="Fish">üê† Fish</button>
              <button type="button" class="pet-tag" data-pet="Small animals">üêπ Small animals</button>
            </div>
            <input type="text" id="pet-notes" placeholder="Notes (e.g. reptiles, no pit bulls‚Ä¶)" />
          </div>
        </div>
      </div>

      <div class="card listing-content-card">
        <div class="card-title">Listing Content <span class="tag-required">Required</span></div>
        <div class="field">
          <label>Listing Description</label>
          <textarea id="description" placeholder="Describe the space ‚Äî amenities, roommates, house rules, parking, utilities included, etc."></textarea>
        </div>
      </div>

      <div class="card">
        <div class="card-title">Upload Photos <span class="tag-required">Required</span></div>
        <div class="upload-zone" id="upload-zone">
          <input type="file" id="photo-input" accept="image/jpeg,image/png" multiple />
          <div class="upload-icon">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
              <path d="M10 13V4M10 4l-3 3M10 4l3 3" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
              <path d="M3 14v2a1 1 0 001 1h12a1 1 0 001-1v-2" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
            </svg>
          </div>
          <div style="font-size:.875rem;font-weight:500;color:var(--ink-soft)">Click to upload photos</div>
          <div class="upload-hint">Drag to Reorder ¬∑ ‚â§20MB each</div> 
          <div class="upload-min">Minimum 3 photos</div>
        </div>
        <div id="photo-strip"></div>
        <div id="photo-count-msg" class="photo-count"></div>
      </div>

      <div class="card">
        <div class="card-title">Lease Type <span class="tag-required">Required</span></div>
        <label class="lease-check" id="lease-check-sublease"><input type="checkbox" id="lease-sublease" /> Sublease</label>
        <label class="lease-check" id="lease-check-takeover"><input type="checkbox" id="lease-takeover" /> Lease Takeover</label>
        <span class="error-msg" id="lease-type-error" style="display:none">Please select at least one lease type.</span>
        <div class="field" style="margin-top:14px">
          <label>Security Deposit <span style="color:var(--ink-muted);font-weight:400">(Optional)</span></label>
          <div class="input-prefix">
            <span>$</span>
            <input type="number" id="deposit" placeholder="0" min="0" />
          </div>
        </div>
      </div>

      <div class="card half-width">
        <div class="card-title">Confirmation</div>
        <div class="confirm-item" id="ci-allowed">
          <input type="checkbox" id="confirm-allowed" />
          <span>I confirm I am allowed to sublease this unit</span>
        </div>
        <div class="confirm-item" id="ci-leaseholder">
          <input type="checkbox" id="confirm-leaseholder" />
          <span>I confirm I am currently a <strong>leaseholder</strong> or authorized to sublease</span>
        </div>
        <div class="confirm-item" id="ci-tos">
          <input type="checkbox" id="confirm-tos" />
          <span>I agree to the <a href="#">Terms of Service</a> &amp; <a href="#">Privacy Policy</a></span>
        </div>
        <div class="confirm-error-banner hidden" id="confirm-error-banner">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><circle cx="8" cy="8" r="7" stroke="currentColor" stroke-width="1.4"/><path d="M8 5v3.5M8 10.5h.01" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
          Please check all boxes above before submitting.
        </div>
      </div>

    </div><div class="submit-row">
      <button type="submit" class="btn-submit">Submit Listing</button>
    </div>
    <p class="footer-note">Only CU Boulder students with @colorado.edu email addresses can post listings. Listings are manually reviewed before being posted.</p>
  </form>

  <div id="success-screen">
    <div class="success-icon">
      <svg width="36" height="36" viewBox="0 0 36 36" fill="none">
        <path d="M8 18l7 7L28 11" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </div>
    <h2 class="success-title">Thank You for Your Submission!</h2>
    <p class="success-sub">Your listing has been received. Before it goes live, please verify your CU Boulder email below.</p>

    <div class="verify-box">
      <h3>Verify Your Email</h3>
      <p>A verification code has been sent to your @colorado.edu address. Enter it below to confirm your listing.</p>
      <p style="font-size:.78rem;color:var(--ink-muted);margin-top:6px;margin-bottom:16px">
        ‚ö†Ô∏è Verification will only be accepted if the code matches what was sent to your actual CU Boulder inbox.
      </p>
      <div class="verify-input-row">
        <input type="text" id="verify-code" placeholder="¬∑ ¬∑ ¬∑ ¬∑ ¬∑ ¬∑" maxlength="8" autocomplete="off" />
        <button type="button" class="btn-verify" id="btn-verify">Verify</button>
      </div>
      <span class="error-msg" id="verify-error" style="display:none;margin-top:8px;text-align:left"></span>
    </div>

    <button type="button" class="btn-edit" id="btn-edit">‚Üê Edit my listing</button>

    <div class="success-next">
      <h4>What happens next</h4>
      <ul>
        <li>Once your email is verified, your listing enters our review queue</li>
        <li>Someone will reach out if we have any questions</li>
        <li>Once approved, your listing goes live on SubSwap for other CU Boulder students</li>
      </ul>
    </div>
  </div>
</main>

<script>
// ==========================================
// 1. INITIALIZE SUPABASE
// ==========================================
const SUPABASE_URL = 'https://doehqqwqwjebhfgdvyum.supabase.co';
const SUPABASE_ANON_KEY = 'sb_publishable_ZZ4mKcw6_e9diz7oFfbVag_YA9zkqFW';

let supabaseClient = null;

try {
  if (window.supabase) {
    supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  } else {
    console.error("Supabase CDN failed to load.");
  }
} catch (error) {
  console.error("Error setting up Supabase:", error);
}

const DRAFT_KEY = 'subswap_draft_v1';
let currentListingId = null; 

document.getElementById('listing-form').addEventListener('keydown', function(e) {
  if (e.key === 'Enter' && e.target.tagName !== 'TEXTAREA') {
    e.preventDefault(); 
  }
});

const hamburger  = document.getElementById('nav-hamburger');
const mobileMenu = document.getElementById('nav-mobile-menu');

hamburger.addEventListener('click', e => {
  e.stopPropagation();
  mobileMenu.classList.toggle('open');
});

document.addEventListener('click', e => {
  if (!e.target.closest('nav.ss-nav')) mobileMenu.classList.remove('open');
});

function setNavPostLinkVisibility(visible) {
  const d = document.getElementById('nav-post-link');
  const m = document.getElementById('nav-post-link-mobile');
  if (d) d.style.display = visible ? '' : 'none';
  if (m) m.style.display = visible ? '' : 'none';
}

// ‚îÄ‚îÄ Photo storage & duplicate/size blocker ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let storedFiles = [];
const strip = document.getElementById('photo-strip');

// Reordering Logic
if (strip) {
  Sortable.create(strip, {
    animation: 150,
    onEnd: () => {
      const newOrder = [];
      strip.querySelectorAll('.photo-thumb-wrap').forEach(el => newOrder.push(storedFiles[el.dataset.index]));
      storedFiles = newOrder;
      renderPhotos();
    }
  });
}

function renderPhotos() {
  const countMsg = document.getElementById('photo-count-msg');
  strip.innerHTML = '';
  storedFiles.forEach((file, i) => {
    const wrap = document.createElement('div');
    wrap.className = 'photo-thumb-wrap';
    wrap.dataset.index = i; // Needed for sortable sync
    const img = document.createElement('img');
    img.src = URL.createObjectURL(file);
    const del = document.createElement('button');
    del.type = 'button'; del.className = 'photo-delete'; del.innerHTML = '‚úï';
    del.addEventListener('click', () => { storedFiles.splice(i, 1); renderPhotos(); if (storedFiles.length >= 3) clearFieldError('upload-zone'); });
    wrap.appendChild(img); wrap.appendChild(del); strip.appendChild(wrap);
  });
  const n = storedFiles.length;
  countMsg.textContent = n > 0 ? `${n} photo${n > 1 ? 's' : ''} added` : '';
}

document.getElementById('photo-input').addEventListener('change', function () {
  Array.from(this.files).forEach(f => {
    if (f.size > 20 * 1024 * 1024) { 
        alert(`The file "${f.name}" is too large. Please select photos under 20MB.`);
        return; 
    }
    const isDuplicate = storedFiles.some(sf => sf.name === f.name && sf.size === f.size);
    if (!isDuplicate) storedFiles.push(f);
  });
  renderPhotos(); 
  this.value = ''; 
  if (storedFiles.length >= 3) clearFieldError('upload-zone');
});

document.getElementById('sem-info-btn').addEventListener('click', () => {
  document.getElementById('sem-info-popup').classList.toggle('visible');
});

// ‚îÄ‚îÄ Google Places Autocomplete ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const addrInput   = document.getElementById('address');
const suggestions = document.getElementById('address-suggestions');
let autocompleteService = null;
let placesService = null;
let sessionToken  = null;

function initGooglePlaces() {
  if (window.google && window.google.maps && window.google.maps.places) {
    autocompleteService = new google.maps.places.AutocompleteService();
    placesService       = new google.maps.places.PlacesService(document.createElement('div'));
    sessionToken        = new google.maps.places.AutocompleteSessionToken();
  }
}
(function waitForGoogle() {
  if (window.google && window.google.maps) initGooglePlaces();
  else setTimeout(waitForGoogle, 300);
})();

async function fetchSuggestionsNominatim(q) {
  try {
    const res  = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(q + ', Boulder, CO')}&format=json&addressdetails=1&limit=5&countrycodes=us`, { headers: { 'Accept-Language': 'en' } });
    const data = await res.json();
    if (!data.length) { suggestions.classList.remove('open'); return; }
    suggestions.innerHTML = data.map(r => {
      const parts = r.display_name.split(',');
      const main  = parts[0];
      const sec   = parts.slice(1, 3).join(',').trim();
      const nbhd  = r.address.neighbourhood || r.address.suburb || r.address.city_district || r.address.quarter || 'Boulder';
      return `<div class="addr-suggestion" data-display="${main}" data-nbhd="${nbhd}">
        <svg width="13" height="13" viewBox="0 0 12 12" fill="none"><path d="M6 1C4.34 1 3 2.34 3 4c0 2.5 3 7 3 7s3-4.5 3-7c0-1.66-1.34-3-3-3z" stroke="currentColor" stroke-width="1.2" fill="none"/><circle cx="6" cy="4" r="1" stroke="currentColor" stroke-width="1"/></svg>
        <div><span class="addr-main">${main}</span><span class="addr-secondary">${sec}</span></div>
      </div>`;
    }).join('') + '<div class="google-attribution">Powered by OpenStreetMap</div>';
    suggestions.classList.add('open');
  } catch(e) { suggestions.classList.remove('open'); }
}

function fetchSuggestionsGoogle(q) {
  if (!autocompleteService) { fetchSuggestionsNominatim(q); return; }
  autocompleteService.getPlacePredictions(
    {
      input: q,
      sessionToken,
      location: new google.maps.LatLng(40.0150, -105.2705),
      radius: 15000,
      types: ['address'],
      componentRestrictions: { country: 'us' }
    },
    (predictions, status) => {
      if (status !== google.maps.places.PlacesServiceStatus.OK || !predictions) {
        suggestions.classList.remove('open'); return;
      }
      suggestions.innerHTML = predictions.map(p => {
        const main = p.structured_formatting.main_text;
        const sec  = p.structured_formatting.secondary_text;
        return `<div class="addr-suggestion" data-place-id="${p.place_id}" data-display="${main}">
          <svg width="13" height="13" viewBox="0 0 12 12" fill="none"><path d="M6 1C4.34 1 3 2.34 3 4c0 2.5 3 7 3 7s3-4.5 3-7c0-1.66-1.34-3-3-3z" stroke="currentColor" stroke-width="1.2" fill="none"/><circle cx="6" cy="4" r="1" stroke="currentColor" stroke-width="1"/></svg>
          <div><span class="addr-main">${main}</span><span class="addr-secondary">${sec}</span></div>
        </div>`;
      }).join('') + '<div class="google-attribution"><span>Powered by</span><img src="https://maps.gstatic.com/mapfiles/api-3/images/google_white5.png" height="11" alt="Google" style="margin-left:4px;filter:brightness(0.6)"/></div>';
      suggestions.classList.add('open');
    }
  );
}

let acTimer = null;
addrInput.addEventListener('input', () => {
  clearTimeout(acTimer);
  const q = addrInput.value.trim();
  if (q.length < 3) { suggestions.classList.remove('open'); return; }
  acTimer = setTimeout(() => {
    if (autocompleteService) fetchSuggestionsGoogle(q);
    else fetchSuggestionsNominatim(q);
  }, 300);
});

function setNeighborhood(nbhd) {
  document.getElementById('neighborhood').value = nbhd;
  document.getElementById('neighborhood-text').textContent = 'üìç ' + nbhd;
  document.getElementById('neighborhood-badge').classList.add('visible');
}

suggestions.addEventListener('click', e => {
  const item = e.target.closest('.addr-suggestion');
  if (!item) return;

  addrInput.value = item.dataset.display;
  suggestions.classList.remove('open');
  clearFieldError('address');
  saveDraft();

  const placeId = item.dataset.placeId;
  if (placeId && placesService) {
    sessionToken = new google.maps.places.AutocompleteSessionToken();
    placesService.getDetails({ placeId, fields: ['address_components'] }, (place, status) => {
      if (status === google.maps.places.PlacesServiceStatus.OK && place) {
        let nbhd = '';
        const specificTypes = ['neighborhood', 'sublocality_level_2', 'sublocality_level_1'];
        for (const targetType of specificTypes) {
          const matchedComponent = place.address_components.find(c => c.types.includes(targetType));
          if (matchedComponent) { 
            nbhd = matchedComponent.long_name; 
            break; 
          }
        }
        if (!nbhd) {
          const localityComp = place.address_components.find(c => c.types.includes('locality'));
          if (localityComp) nbhd = localityComp.long_name;
        }
        setNeighborhood(nbhd || 'Boulder');
      }
    });
  } else if (item.dataset.nbhd) {
    setNeighborhood(item.dataset.nbhd);
  }
});

document.addEventListener('click', e => {
  if (!e.target.closest('.address-wrap')) suggestions.classList.remove('open');
});

async function lookupNeighborhood() {
  const addr = addrInput.value.trim();
  if (!addr) return;
  if (document.getElementById('neighborhood').value) return;
  const badge = document.getElementById('neighborhood-badge');
  const txt   = document.getElementById('neighborhood-text');
  txt.textContent = 'Detecting neighborhood‚Ä¶';
  badge.classList.add('visible');
  try {
    const res  = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(addr + ', Boulder, CO')}&format=json&addressdetails=1&limit=1`, { headers: { 'Accept-Language': 'en' } });
    const data = await res.json();
    if (data && data[0]) {
      const a    = data[0].address;
      const nbhd = a.neighbourhood || a.suburb || a.city_district || a.quarter || 'Boulder';
      setNeighborhood(nbhd);
      saveDraft();
    } else {
      txt.textContent = 'Could not detect ‚Äî check address';
    }
  } catch(e) {
    txt.textContent = 'Lookup unavailable';
  }
}

addrInput.addEventListener('input', () => { document.getElementById('neighborhood').value = ''; });
addrInput.addEventListener('blur', () => setTimeout(lookupNeighborhood, 250));

const emailInput = document.getElementById('email');
const emailError = document.getElementById('email-error');

function validateEmail() {
  const v = emailInput.value.trim();
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/; 
  
  if (!v) { 
    emailError.textContent = 'Email is required.'; 
    emailError.style.display = 'block'; 
    emailInput.style.borderColor = 'var(--red)'; 
    return false; 
  }
  if (!emailRegex.test(v)) {
    emailError.textContent = 'Please enter a valid email format.'; 
    emailError.style.display = 'block'; 
    emailInput.style.borderColor = 'var(--red)'; 
    return false; 
  }
  if (!v.toLowerCase().endsWith('@colorado.edu')) { 
    emailError.textContent = 'Must be a @colorado.edu email address.'; 
    emailError.style.display = 'block'; 
    emailInput.style.borderColor = 'var(--red)'; 
    return false; 
  }
  
  emailError.style.display = 'none'; 
  emailInput.style.borderColor = ''; 
  return true;
}

emailInput.addEventListener('blur', validateEmail);
emailInput.addEventListener('input', () => {
  if (emailInput.value.toLowerCase().endsWith('@colorado.edu')) { 
    emailError.style.display = 'none'; 
    emailInput.style.borderColor = ''; 
  }
});

function validateDates(onSubmit) {
  const startEl = document.getElementById('start-date'), endEl = document.getElementById('end-date');
  const startErr = document.getElementById('start-error'), endErr = document.getElementById('end-error');
  const today = new Date(); today.setHours(0,0,0,0);
  let valid = true;
  if (onSubmit || startEl.value) {
    startErr.textContent = ''; startErr.classList.remove('visible');
    if (!startEl.value) { if (onSubmit) { startErr.textContent = 'Please select a start date.'; startErr.classList.add('visible'); valid = false; } }
    else if (new Date(startEl.value + 'T00:00:00') < today) { startErr.textContent = 'Start date cannot be in the past.'; startErr.classList.add('visible'); valid = false; }
  } else if (!startEl.value) valid = false;
  if (onSubmit || endEl.value) {
    endErr.textContent = ''; endErr.classList.remove('visible');
    if (!endEl.value) { if (onSubmit) { endErr.textContent = 'Please select an end date.'; endErr.classList.add('visible'); valid = false; } }
    else if (startEl.value && new Date(endEl.value + 'T00:00:00') <= new Date(startEl.value + 'T00:00:00')) { endErr.textContent = 'End date must be after start date.'; endErr.classList.add('visible'); valid = false; }
  } else if (!endEl.value) valid = false;
  return valid;
}
document.getElementById('start-date').addEventListener('change', () => validateDates(false));
document.getElementById('end-date').addEventListener('change', () => validateDates(false));

['housing-type','unit-type'].forEach(id => {
  document.getElementById(id).addEventListener('click', e => {
    const btn = e.target.closest('.toggle-btn'); if (!btn) return;
    document.getElementById(id).querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    if (id === 'unit-type') document.getElementById('room-until-field').style.display = btn.dataset.val === 'room-shared' ? 'block' : 'none';
    saveDraft();
  });
});

const prefEmailBtn = document.getElementById('pref-email');
const prefTextBtn  = document.getElementById('pref-text');
[prefEmailBtn, prefTextBtn].forEach(btn => btn.addEventListener('click', () => {
  [prefEmailBtn, prefTextBtn].forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  saveDraft();
}));

document.querySelectorAll('input[name="pets-prop"]').forEach(r => r.addEventListener('change', () => {
  document.getElementById('pets-expand').classList.toggle('open', r.value === 'yes' && r.checked);
  saveDraft();
}));
document.querySelectorAll('.pet-tag').forEach(t => t.addEventListener('click', () => {
    t.classList.toggle('active');
    saveDraft();
}));

document.querySelectorAll('input[name="furnished"]').forEach(r => r.addEventListener('change', () => {
  document.getElementById('furnished-expand').classList.toggle('open', r.value === 'yes' && r.checked);
  saveDraft();
}));

['confirm-allowed','confirm-leaseholder','confirm-tos'].forEach(id => {
  document.getElementById(id).addEventListener('change', function () {
    if (this.checked) this.closest('.confirm-item').classList.remove('error');
    const anyUnchecked = ['confirm-allowed','confirm-leaseholder','confirm-tos'].some(i => !document.getElementById(i).checked);
    if (!anyUnchecked) document.getElementById('confirm-error-banner').classList.add('hidden');
    saveDraft();
  });
});

['lease-sublease','lease-takeover'].forEach(id => {
  document.getElementById(id).addEventListener('change', () => {
    const either = document.getElementById('lease-sublease').checked || document.getElementById('lease-takeover').checked;
    if (either) {
      document.getElementById('lease-type-error').style.display = 'none';
      document.getElementById('lease-check-sublease').classList.remove('error');
      document.getElementById('lease-check-takeover').classList.remove('error');
    }
    saveDraft();
  });
});

function showFieldError(id, msg) {
  const el = document.getElementById(id); if (!el) return;
  el.style.borderColor = 'var(--red)';
  const p = el.closest('.field') || el.parentElement;
  if (!p.querySelector('.error-msg')) { const e = document.createElement('span'); e.className = 'error-msg'; e.textContent = msg; p.appendChild(e); }
}
function clearFieldError(id) {
  const el = document.getElementById(id); if (!el) return;
  el.style.borderColor = '';
  const p = el.closest('.field') || el.parentElement;
  p.querySelectorAll('.error-msg').forEach(e => e.remove());
}
document.getElementById('rent').addEventListener('input', () => clearFieldError('rent'));
document.getElementById('address').addEventListener('input', () => clearFieldError('address'));
document.getElementById('description').addEventListener('input', () => clearFieldError('description'));

let autosaveTimer;
function showAutosaveBadge() {
  const badge = document.getElementById('autosave-badge');
  badge.classList.add('visible');
  clearTimeout(autosaveTimer);
  autosaveTimer = setTimeout(() => {
    badge.classList.remove('visible');
  }, 2000);
}

function saveDraft() {
  const data = {
    email: emailInput.value,
    firstName: document.getElementById('first-name').value,
    lastName: document.getElementById('last-name').value,
    rent: document.getElementById('rent').value,
    address: addrInput.value,
    unit: document.getElementById('unit-number').value,
    beds: document.getElementById('beds').value,
    baths: document.getElementById('baths').value,
    furnished: document.querySelector('input[name="furnished"]:checked')?.value || '',
    furnishedNotes: document.getElementById('furnished-notes').value,
    startDate: document.getElementById('start-date').value,
    endDate: document.getElementById('end-date').value,
    flexible: document.querySelector('input[name="flexible"]:checked')?.value || '',
    phone: document.getElementById('phone').value,
    bestTime: document.getElementById('best-time').value,
    housingType: document.querySelector('#housing-type .toggle-btn.active')?.dataset.val || '',
    unitType: document.querySelector('#unit-type .toggle-btn.active')?.dataset.val || '',
    roomUntil: document.getElementById('room-until').value,
    genderPref: document.getElementById('gender-pref').value,
    petsProp: document.querySelector('input[name="pets-prop"]:checked')?.value || '',
    pets: [...document.querySelectorAll('.pet-tag.active')].map(t => t.dataset.pet),
    petNotes: document.getElementById('pet-notes').value,
    description: document.getElementById('description').value,
    leaseSublease: document.getElementById('lease-sublease').checked,
    leaseTakeover: document.getElementById('lease-takeover').checked,
    deposit: document.getElementById('deposit').value,
    prefContact: prefEmailBtn.classList.contains('active') ? 'email' : 'text'
  };
  localStorage.setItem(DRAFT_KEY, JSON.stringify(data));
  showAutosaveBadge();
}

function loadDraft() {
  const raw = localStorage.getItem(DRAFT_KEY);
  if (!raw) return;
  try {
    const draft = JSON.parse(raw);
    if(draft.email) emailInput.value = draft.email;
    if(draft.firstName) document.getElementById('first-name').value = draft.firstName;
    if(draft.lastName) document.getElementById('last-name').value = draft.lastName;
    if(draft.rent) document.getElementById('rent').value = draft.rent;
    if(draft.address) { addrInput.value = draft.address; setTimeout(lookupNeighborhood, 100); }
    if(draft.unit) document.getElementById('unit-number').value = draft.unit;
    if(draft.beds) document.getElementById('beds').value = draft.beds;
    if(draft.baths) document.getElementById('baths').value = draft.baths;
    
    if(draft.furnished) {
      document.querySelector(`input[name="furnished"][value="${draft.furnished}"]`).checked = true;
      if(draft.furnished === 'yes') document.getElementById('furnished-expand').classList.add('open');
    }
    if(draft.furnishedNotes) document.getElementById('furnished-notes').value = draft.furnishedNotes;
    
    if(draft.startDate) document.getElementById('start-date').value = draft.startDate;
    if(draft.endDate) document.getElementById('end-date').value = draft.endDate;
    if(draft.flexible) document.querySelector(`input[name="flexible"][value="${draft.flexible}"]`).checked = true;
    if(draft.phone) document.getElementById('phone').value = draft.phone;
    if(draft.bestTime) document.getElementById('best-time').value = draft.bestTime;
    
    if(draft.housingType) {
        document.querySelectorAll('#housing-type .toggle-btn').forEach(b => b.classList.remove('active'));
        const btn = document.querySelector(`#housing-type .toggle-btn[data-val="${draft.housingType}"]`);
        if(btn) btn.classList.add('active');
    }
    if(draft.unitType) {
        document.querySelectorAll('#unit-type .toggle-btn').forEach(b => b.classList.remove('active'));
        const btn = document.querySelector(`#unit-type .toggle-btn[data-val="${draft.unitType}"]`);
        if(btn) {
            btn.classList.add('active');
            if (draft.unitType === 'room-shared') document.getElementById('room-until-field').style.display = 'block';
        }
    }
    if(draft.roomUntil) document.getElementById('room-until').value = draft.roomUntil;
    if(draft.genderPref) document.getElementById('gender-pref').value = draft.genderPref;
    
    if(draft.petsProp) {
        document.querySelector(`input[name="pets-prop"][value="${draft.petsProp}"]`).checked = true;
        if(draft.petsProp === 'yes') document.getElementById('pets-expand').classList.add('open');
    }
    if(draft.pets && Array.isArray(draft.pets)) {
        draft.pets.forEach(p => {
            const tag = document.querySelector(`.pet-tag[data-pet="${p}"]`);
            if(tag) tag.classList.add('active');
        });
    }
    if(draft.petNotes) document.getElementById('pet-notes').value = draft.petNotes;
    if(draft.description) document.getElementById('description').value = draft.description;
    
    if(draft.leaseSublease) document.getElementById('lease-sublease').checked = true;
    if(draft.leaseTakeover) document.getElementById('lease-takeover').checked = true;
    if(draft.deposit) document.getElementById('deposit').value = draft.deposit;
    
    if(draft.prefContact === 'email') { prefEmailBtn.classList.add('active'); prefTextBtn.classList.remove('active'); } 
    else { prefTextBtn.classList.add('active'); prefEmailBtn.classList.remove('active'); }
  } catch(e) { console.error("Draft load failed:", e); }
}

const formEl = document.getElementById('listing-form');
formEl.addEventListener('input', saveDraft);
formEl.addEventListener('change', saveDraft);
document.addEventListener('DOMContentLoaded', loadDraft);

function buildPayload(photoUrls = []) {
  const pets = [...document.querySelectorAll('.pet-tag.active')].map(t => t.dataset.pet).join(', ');
  const petsNotes = document.getElementById('pet-notes').value.trim();
  const petsVal = document.querySelector('input[name="pets-prop"]:checked')?.value || '';
  
  const furnVal = document.querySelector('input[name="furnished"]:checked')?.value || '';
  const furnNotes = document.getElementById('furnished-notes').value.trim();
  const furnStr = (furnVal === 'yes' && furnNotes) ? `Yes (${furnNotes})` : (furnVal === 'yes' ? 'Yes' : null);

  const rentVal = document.getElementById('rent').value;
  const depositVal = document.getElementById('deposit').value;

  return {
    email: emailInput.value,
    first_name: document.getElementById('first-name').value,
    last_name: document.getElementById('last-name').value || null,
    monthly_rent: rentVal ? parseInt(rentVal) : null,
    address: addrInput.value,
    unit_number: document.getElementById('unit-number').value || null,
    neighborhood: document.getElementById('neighborhood').value || null,
    beds: document.getElementById('beds').value || null,
    baths: document.getElementById('baths').value || null,
    furnished: furnStr,
    start_date: document.getElementById('start-date').value || null,
    end_date: document.getElementById('end-date').value || null,
    flexible_movein: document.querySelector('input[name="flexible"]:checked')?.value || null,
    phone: document.getElementById('phone').value || null,
    preferred_contact: prefEmailBtn.classList.contains('active') ? 'Email' : 'Text',
    best_time: document.getElementById('best-time').value || null,
    housing_type: document.querySelector('#housing-type .toggle-btn.active')?.dataset.val || null,
    unit_type: document.querySelector('#unit-type .toggle-btn.active')?.dataset.val || null,
    gender_preference: document.getElementById('gender-pref').value || null,
    pets: petsVal === 'yes' ? [pets, petsNotes].filter(Boolean).join('; ') : 'No',
    description: document.getElementById('description').value,
    lease_type: [document.getElementById('lease-sublease').checked ? 'Sublease' : '', document.getElementById('lease-takeover').checked ? 'Lease Takeover' : ''].filter(Boolean).join(', ') || null,
    security_deposit: depositVal ? parseInt(depositVal) : null,
    photo_urls: photoUrls,
    status: 'pending',
    verified: false
  };
}

// ‚îÄ‚îÄ SUBMIT TO SUPABASE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById('listing-form').addEventListener('submit', async e => {
  e.preventDefault();
  let valid = true;
  
  // 1. Email Regex
  if (!validateEmail()) valid = false;
  
  // 2. Positive Rent Validation
  const rentEl = document.getElementById('rent');
  const rentVal = parseInt(rentEl.value);
  if (isNaN(rentVal) || rentVal <= 0) { 
    showFieldError('rent', 'Please enter a positive rent amount.'); 
    valid = false; 
  } else clearFieldError('rent');
  
  // 3. Positive Deposit Validation
  const depEl = document.getElementById('deposit');
  if (depEl.value) {
    const depVal = parseInt(depEl.value);
    if (depVal < 0) { 
      showFieldError('deposit', 'Deposit cannot be negative.'); 
      valid = false; 
    } else clearFieldError('deposit');
  }

  if (!addrInput.value.trim()) { showFieldError('address', 'Please enter the street address.'); valid = false; } else clearFieldError('address');
  if (!document.getElementById('description').value.trim()) { showFieldError('description', 'Please add a listing description.'); valid = false; } else clearFieldError('description');
  
  // 4. Date and 30-Day Validation
  if (!validateDates(true)) {
    valid = false;
  } else {
    const startVal = document.getElementById('start-date').value;
    const endVal = document.getElementById('end-date').value;
    if (startVal && endVal) {
      const startDate = new Date(startVal + 'T00:00:00');
      const endDate = new Date(endVal + 'T00:00:00');
      const diffDays = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
      if (diffDays < 30) {
        const endErr = document.getElementById('end-error');
        endErr.textContent = `Listings must be at least 30 days (currently ${diffDays} days).`;
        endErr.classList.add('visible');
        valid = false;
      }
    }
  }
  
  if (storedFiles.length < 3) {
    valid = false;
    const zone = document.getElementById('upload-zone');
    zone.style.borderColor = 'var(--red)';
    const p = zone.parentElement;
    if (!p.querySelector('.error-msg')) { const err = document.createElement('span'); err.className = 'error-msg'; err.textContent = 'Please upload at least 3 photos.'; zone.after(err); }
  } else { document.getElementById('upload-zone').style.borderColor = ''; document.getElementById('upload-zone').parentElement.querySelectorAll('.error-msg').forEach(e => e.remove()); }

  const leaseChecked = document.getElementById('lease-sublease').checked || document.getElementById('lease-takeover').checked;
  if (!leaseChecked) {
    valid = false;
    document.getElementById('lease-type-error').style.display = 'block';
    document.getElementById('lease-check-sublease').classList.add('error');
    document.getElementById('lease-check-takeover').classList.add('error');
  } else {
    document.getElementById('lease-type-error').style.display = 'none';
    document.getElementById('lease-check-sublease').classList.remove('error');
    document.getElementById('lease-check-takeover').classList.remove('error');
  }

  let anyConfirmUnchecked = false;
  ['confirm-allowed','confirm-leaseholder','confirm-tos'].forEach(id => {
    const cb = document.getElementById(id);
    if (!cb.checked) {
      valid = false;
      anyConfirmUnchecked = true;
      cb.closest('.confirm-item').classList.add('error');
    } else {
      cb.closest('.confirm-item').classList.remove('error');
    }
  });
  
  const banner = document.getElementById('confirm-error-banner');
  if (anyConfirmUnchecked) { banner.classList.remove('hidden'); } else { banner.classList.add('hidden'); }

  if (!valid) return;
  
  const submitBtn = document.querySelector('.btn-submit');
  const originalBtnText = submitBtn.textContent;
  
  if (!supabaseClient) {
    alert("Database connection failed. Please refresh the page and try again.");
    return;
  }
  
  submitBtn.textContent = 'Uploading Photos...';
  submitBtn.disabled = true;
  
  try { 
    const BUCKET_NAME = 'listing-photos'; 
    const uploadedUrls = [];

    const folderName = currentListingId ? currentListingId : `submission-${Date.now()}`;

    // Reordered Photo Loop
    for (let i = 0; i < storedFiles.length; i++) {
      const file = storedFiles[i];
      const fileExt = file.name.split('.').pop();
      const filePath = `${folderName}/${i}_${Date.now()}-${Math.random().toString(36).substring(2)}.${fileExt}`;
      
      const { data: uploadData, error: uploadError } = await supabaseClient.storage
        .from(BUCKET_NAME)
        .upload(filePath, file);

      if (uploadError) {
        throw new Error('Image upload failed: ' + uploadError.message);
      }

      const { data: publicUrlData } = supabaseClient.storage
        .from(BUCKET_NAME)
        .getPublicUrl(filePath);

      uploadedUrls.push(publicUrlData.publicUrl);
    }

    submitBtn.textContent = 'Saving Listing...';
    const payload = buildPayload(uploadedUrls); 
    
    if (currentListingId) {
      const { error } = await supabaseClient
        .from('listings')
        .update(payload)
        .eq('id', currentListingId); 
      if (error) throw new Error('Database update error: ' + error.message);
    } else {
      const { data, error } = await supabaseClient
        .from('listings')
        .insert([payload])
        .select(); 
      if (error) throw new Error('Database insert error: ' + error.message);
      if (data && data.length > 0) {
        currentListingId = data[0].id;
      }
    }

  } catch(err) {
    console.error("Submission Error:", err);
    alert("There was an issue: " + err.message);
    submitBtn.textContent = originalBtnText;
    submitBtn.disabled = false;
    return;
  }
  
  localStorage.removeItem(DRAFT_KEY);
  document.getElementById('listing-form').style.display = 'none';
  document.getElementById('success-screen').classList.add('visible');
  document.querySelector('.page-title').style.display = 'none';
  document.querySelector('.email-notice').style.display = 'none';
  document.getElementById('autosave-badge').style.display = 'none'; 
  setNavPostLinkVisibility(false);
  window.scrollTo({ top: 0, behavior: 'smooth' });
});

document.getElementById('btn-edit').addEventListener('click', () => {
  document.getElementById('success-screen').classList.remove('visible');
  document.getElementById('listing-form').style.display = '';
  document.querySelector('.page-title').style.display = '';
  document.querySelector('.email-notice').style.display = '';
  document.getElementById('autosave-badge').style.display = '';
  
  const submitBtn = document.querySelector('.btn-submit');
  submitBtn.textContent = 'Submit Listing';
  submitBtn.disabled = false;
  
  setNavPostLinkVisibility(true);
  window.scrollTo({ top: 0, behavior: 'smooth' });
});

document.getElementById('btn-verify').addEventListener('click', () => {
  const code = document.getElementById('verify-code').value.trim();
  const errEl = document.getElementById('verify-error');
  if (!code) { errEl.textContent = 'Please enter the verification code.'; errEl.style.display = 'block'; return; }
  errEl.style.display = 'none';
  document.querySelector('.verify-box').innerHTML = '<p style="color:var(--green);font-weight:600;font-size:.9375rem">‚úì Email verified! Your listing is now in review.</p>';
});
</script>
</body>
</html>